!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const a of t)if("childList"===a.type)for(const t of a.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t={BREATHING:{DEFAULT_ROUNDS:3,MIN_ROUNDS:1,MAX_ROUNDS:10,BREATHS_PER_ROUND:30,INHALE_DURATION:2e3,EXHALE_DURATION:2e3,HOLD_DURATION:15e3,RECOVERY:{INHALE:2e3,HOLD:15e3,EXHALE:2e3},FINAL_RECOVERY:{INHALE:2e3,HOLD:15e3,EXHALE:2e3}},YOUTUBE:{PLAYLIST_ID:"PLstkrDtqpxiIWWU4ctz1Hg_U_XpUo5zr4",PLAYER_VARS:{autoplay:1,controls:0,disablekb:1,fs:0,modestbranding:1,playsinline:1,playlist:"PLstkrDtqpxiIWWU4ctz1Hg_U_XpUo5zr4",enablejsapi:1,origin:window.location.origin}},ANIMATIONS:{BREATH_IN:"breathIn",BREATH_OUT:"breathOut",PULSE:"pulse"},CLASSES:{ACTIVE:"active",PLAYING:"playing",HIDDEN:"hidden"},SELECTORS:{BREATH_CIRCLE:"#breathCircle",CIRCLE_TEXT:"#circleText",PHASE_TEXT:"#phaseText",TIMER:"#timer",PROGRESS_BAR:"#progressBar",ROUNDS_COUNT:"#roundsCount",CURRENT_ROUND:"#currentRound",TOTAL_ROUNDS:"#totalRounds",MUSIC_CONTROL:"#musicControl",YOUTUBE_PLAYER:"#youtubePlayer",LOADER:"#loader",TUTORIAL:"#tutorial",TUTORIAL_CLOSE:"#closeTutorial"},MESSAGES:{START:"Начать",INHALE:"Вдох",EXHALE:"Выдох",HOLD:"Задержка",RECOVERY:"Восстановление",FINAL_HOLD:"Финальная задержка",FINISH:"Завершено",PRESS_TO_START:"Нажмите, чтобы начать",PRESS_TO_CONTINUE:"Нажмите, чтобы продолжить"},KEY_CODES:{SPACE:"Space",ESCAPE:"Escape",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight"},I18N:{ru:{start:"Начать",inhale:"Вдох",exhale:"Выдох",hold:"Задержка",recovery:"Восстановление",round:"Раунд",of:"из",today:"Сегодня",allTime:"Все время",sessions:"Сессий",bestTime:"Лучшее время",avgTime:"Среднее время",streak:"Дней подряд",achievements:"Достижения"},en:{start:"Start",inhale:"Inhale",exhale:"Exhale",hold:"Hold",recovery:"Recovery",round:"Round",of:"of",today:"Today",allTime:"All Time",sessions:"Sessions",bestTime:"Best Time",avgTime:"Average Time",streak:"Day Streak",achievements:"Achievements"}}},e={isBreathing:!1,isPaused:!1,currentPhase:"idle",rounds:{current:0,total:t.BREATHING.DEFAULT_ROUNDS,breathCount:0},timer:{startTime:null,duration:0,interval:null,remainingTime:0},settings:{rounds:3,breathCount:30,darkMode:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,language:"ru",soundEnabled:!0,volume:50,soundEffects:!0,voicePrompts:!1,hapticFeedback:!0,lastUpdated:(new Date).toISOString()},music:{isPlaying:!1,isMuted:!1,volume:.5,currentTrack:null,player:null},stats:{today:{sessions:0,bestTime:0,times:[]},allTime:{sessions:0,bestTime:0,times:[],streak:0,lastPractice:null}},achievements:{firstSession:!1,weekStreak:!1,monthStreak:!1,master:!1},tutorial:{isCompleted:!1,currentStep:0,steps:["Добро пожаловать в приложение для дыхания по методу Вим Хофа!","Настройте количество раундов с помощью кнопок + и -","Нажмите на круг, чтобы начать сессию","Следуйте инструкциям на экране: Вдох - Задержка - Выдох","Наслаждайтесь процессом и дышите осознанно!"]}};let a={...e};const s=[];function i(t,e=!1){a={...a,...t},r(),(e||void 0!==t.isBreathing||void 0!==t.currentPhase||void 0!==t.rounds||void 0!==t.stats)&&o()}function n(){a={...e},r(),o()}function r(){s.forEach(t=>t(a))}function o(){try{if("undefined"==typeof localStorage)return;const e=JSON.parse(JSON.stringify({settings:a.settings,stats:a.stats,achievements:a.achievements,tutorial:a.tutorial,rounds:a.rounds}));try{localStorage.setItem("whmAppState",JSON.stringify(e))}catch(t){if("QuotaExceededError"!==t.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==t.name)throw t;{localStorage.removeItem("whmAppState");const t={settings:e.settings,stats:e.stats,rounds:e.rounds};localStorage.setItem("whmAppState",JSON.stringify(t))}}}catch(e){try{localStorage.setItem("whmAppState",JSON.stringify({settings:a.settings,stats:a.stats}))}catch(t){}}}function l(){if(function(){try{if("undefined"==typeof localStorage)return;const e=localStorage.getItem("whmAppState");if(!e)return;try{const t=JSON.parse(e),s=(t,e)=>e?{...t||{},...e||{}}:t||{},i={...a,settings:s(a.settings,t.settings),stats:s(a.stats,t.stats),achievements:s(a.achievements,t.achievements),tutorial:s(a.tutorial,t.tutorial),rounds:s(a.rounds,t.rounds)};Object.assign(a,i),a.stats=a.stats||{},a.stats.today=a.stats.today||{sessions:0,bestTime:0,times:[]},a.stats.allTime=a.stats.allTime||{sessions:0,bestTime:0,times:[],streak:0,lastPractice:null},r()}catch(t){n()}}catch(e){n()}}(),a.rounds=a.rounds||{current:1,total:t.BREATHING.DEFAULT_ROUNDS,breathCount:0},a.rounds.current=1,a.tutorial&&a.tutorial.isCompleted||(a.tutorial=a.tutorial||{},a.tutorial.isActive=!0),a.settings=a.settings||{},void 0===a.settings.darkMode){const t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;a.settings.darkMode=t}document.documentElement.setAttribute("data-theme",a.settings.darkMode?"dark":"light"),function(){try{!function(){try{const e=localStorage.getItem("lastSessionStats");if(e)try{const t=JSON.parse(e),a=new Date(t.timestamp),s=new Date;s-a<864e5&&i({stats:t.stats},!0),localStorage.removeItem("lastSessionStats")}catch(t){localStorage.removeItem("lastSessionStats")}const s=localStorage.getItem("errorSessionBackup");if(s)try{const t=JSON.parse(s);i({stats:{...a.stats,allTime:{...a.stats?.allTime||{},sessions:(a.stats?.allTime?.sessions||0)+1,bestTime:Math.max(a.stats?.allTime?.bestTime||0,t.duration||0),lastPractice:t.timestamp||(new Date).toISOString()},today:{...a.stats?.today||{},sessions:(a.stats?.today?.sessions||0)+1,bestTime:Math.max(a.stats?.today?.bestTime||0,t.duration||0)}}},!0),localStorage.removeItem("errorSessionBackup")}catch(t){localStorage.removeItem("errorSessionBackup")}}catch(e){}}();const t=a.stats?.allTime?.lastPractice?new Date(a.stats.allTime.lastPractice):null,e=new Date,s=new Date(e);if(s.setDate(s.getDate()-1),!t)return void i({stats:{...a.stats,allTime:{...a.stats?.allTime||{},streak:0,lastPractice:e.toISOString()}}},!0);t.getDate()!==s.getDate()&&t.getDate()!==e.getDate()&&i({stats:{...a.stats,allTime:{...a.stats.allTime,streak:0,lastPractice:e.toISOString()}}},!0)}catch(t){}}(),i({},!0)}new class{constructor(){this.animations=new Map,this.initAnimations()}initAnimations(){this.defineAnimation("breathIn",{keyframes:[{transform:"scale(1)",opacity:.8},{transform:"scale(1.2)",opacity:1}],options:{duration:4e3,easing:"ease-in-out",fill:"forwards"}}),this.defineAnimation("breathOut",{keyframes:[{transform:"scale(1.2)",opacity:1},{transform:"scale(1)",opacity:.8}],options:{duration:8e3,easing:"ease-in-out",fill:"forwards"}}),this.defineAnimation("pulse",{keyframes:[{transform:"scale(1)"},{transform:"scale(1.05)"},{transform:"scale(1)"}],options:{duration:1500,easing:"ease-in-out",iterations:1/0}})}defineAnimation(t,{keyframes:e,options:a}){this.animations.set(t,{keyframes:e,options:a})}animate(t,e,a=null){if(!t)return null;this.stopAnimation(t);const s=this.animations.get(e);if(!s)return null;const i=t.animate(s.keyframes,s.options);return a&&(i.onfinish=a),t.dataset.currentAnimation=e,i}stopAnimation(t){if(!t)return;t.getAnimations().forEach(t=>{t.cancel()}),delete t.dataset.currentAnimation}breathIn(t,e=4e3){return this.animate(t,"breathIn",{duration:e,easing:"ease-in-out",fill:"forwards"})}breathOut(t,e=8e3){return this.animate(t,"breathOut",{duration:e,easing:"ease-in-out",fill:"forwards"})}pulse(t){return this.animate(t,"pulse")}fadeIn(t,e=300){return t.style.opacity="0",t.style.display="block",this.animate(t,{keyframes:[{opacity:0},{opacity:1}],options:{duration:e,easing:"ease-in-out",fill:"forwards"}})}fadeOut(t,e=300){return new Promise(a=>{this.animate(t,{keyframes:[{opacity:1},{opacity:0}],options:{duration:e,easing:"ease-in-out",fill:"forwards"}}).onfinish=()=>{t.style.display="none",a()}})}};const c=new class{constructor(){this.chart=null,this.chartCtx=null}init(){try{const t=document.getElementById("dailyStatsChart");return!!t&&(this.chartCtx=t.getContext("2d"),!!this.chartCtx&&(this.initChart(),!0))}catch(t){return!1}}initChart(){try{if(!this.chartCtx)return;const t=this.getLastWeekData(),e={type:"line",data:{labels:t.labels,datasets:[{label:"Время задержки (сек)",data:t.data,borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2,tension:.4,fill:!0,pointBackgroundColor:"rgba(75, 192, 192, 1)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgba(75, 192, 192, 1)"}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:0},plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(t){return`Время: ${t.parsed.y} сек`}}}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Секунды",color:"#666",font:{weight:"bold"}},grid:{color:"rgba(0, 0, 0, 0.05)"},ticks:{stepSize:10}},x:{title:{display:!0,text:"День недели",color:"#666",font:{weight:"bold"}},grid:{display:!1}}},layout:{padding:{top:10,right:15,bottom:10,left:10}},elements:{line:{borderWidth:2},point:{radius:4,hoverRadius:6}}}};this.chart&&this.chart.destroy(),this.chart=new Chart(this.chartCtx,e)}catch(t){}}updateChart(){try{const t=this.getLastWeekData();if(!this.chart)return void this.initChart();if(!this.chart)return;if(!t||!t.labels||!t.data)return;this.chart.data.labels=t.labels,this.chart.data.datasets[0].data=t.data;const e=Math.max(...t.data,10);this.chart.options.scales.y.max=10*Math.ceil(e/10),this.chart.options.scales.y.ticks.stepSize=Math.max(5,5*Math.ceil(e/50)),this.chart.update({duration:800,easing:"easeInOutQuart"})}catch(t){try{this.chart&&(this.chart.destroy(),this.chart=null),this.initChart()}catch(e){}}}getLastWeekData(){const t={labels:[],data:[]};try{const e=new Date,s=a.stats?.allTime||{},i=a.stats?.today||{};for(let a=6;a>=0;a--){const n=new Date(e);n.setDate(n.getDate()-a);const r=n.toISOString().split("T")[0],o=this.getDayName(n.getDate(),n.getMonth(),n.getFullYear()),l=0===a;let c=0;if(l&&i.date===r)c=i.bestTime||0;else if(Array.isArray(s.times)){const t=s.times.filter(t=>{if(!t)return!1;if("number"==typeof t)return l;if(t.timestamp)try{const e=new Date(t.timestamp);return!isNaN(e.getTime())&&e.toISOString().split("T")[0]===r}catch(e){return!1}return!1}).map(t=>"number"==typeof t?t:Number(t?.duration)||0);c=t.length>0?Math.max(...t):0}t.labels.push(o),t.data.push(c)}return t}catch(e){return{labels:["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],data:[0,0,0,0,0,0,0]}}}getDayName(t,e,a){return["Вс","Пн","Вт","Ср","Чт","Пт","Сб"][new Date(a,e,t).getDay()]}updateStatsDisplay(){try{a.stats||(a.stats={today:{},allTime:{}}),a.stats.allTime||(a.stats.allTime={sessions:0,bestTime:0,times:[],streak:0,lastPractice:null}),a.stats.today||(a.stats.today={sessions:0,bestTime:0,date:(new Date).toISOString().split("T")[0],times:[]});const t=document.getElementById("sessionsToday"),e=document.getElementById("bestTimeToday"),s=document.getElementById("avgTimeToday");t&&(t.textContent=a.stats.today.sessions||0),e&&(e.textContent=this.formatTime(a.stats.today.bestTime||0)),s&&(s.textContent=this.calculateAverageTime(a.stats.today.times));const i=document.getElementById("totalSessions"),n=document.getElementById("bestTimeAll"),r=document.getElementById("avgTimeAll"),o=document.getElementById("streakDays");i&&(i.textContent=a.stats.allTime.sessions||0),n&&(n.textContent=this.formatTime(a.stats.allTime.bestTime||0)),r&&(r.textContent=this.calculateAverageTime(a.stats.allTime.times)),o&&(o.textContent=a.stats.allTime.streak||0),setTimeout(()=>{this.updateChart()},100)}catch(t){}}calculateAverageTime(t){if(!t||0===t.length)return this.formatTime(0);const e=t.reduce((t,e)=>t+e,0),a=Math.round(e/t.length);return this.formatTime(a)}formatTime(t){if(isNaN(t))return"00:00";const e=Math.floor(t/60),a=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}addSession(t){const e=new Date;e.toISOString().split("T")[0];const s=a.stats.allTime.lastPractice?new Date(a.stats.allTime.lastPractice):null;let n=a.stats.allTime.streak;if(s){const t=Math.floor((e-s)/864e5);1===t?n++:t>1&&(n=1)}else n=1;i({stats:{today:{...a.stats.today,sessions:a.stats.today.sessions+1,bestTime:Math.max(a.stats.today.bestTime,t),times:[...a.stats.today.times,{timestamp:e,duration:t}]},allTime:{...a.stats.allTime,sessions:a.stats.allTime.sessions+1,bestTime:Math.max(a.stats.allTime.bestTime,t),times:[...a.stats.allTime.times,{timestamp:e,duration:t}],streak:n,lastPractice:e.toISOString()}}}),this.updateStatsDisplay(),this.checkAchievements()}checkAchievements(){const t={...a.achievements};let e=!1;a.stats.allTime.sessions>=1&&!t.firstSession&&(t.firstSession=!0,e=!0,this.showAchievement("Первая сессия","Вы завершили свою первую сессию дыхания!")),a.stats.allTime.streak>=7&&!t.weekStreak&&(t.weekStreak=!0,e=!0,this.showAchievement("Неделя практики","7 дней подряд практики дыхания!")),a.stats.allTime.streak>=30&&!t.monthStreak&&(t.monthStreak=!0,e=!0,this.showAchievement("Месяц практики","30 дней подряд практики дыхания!")),a.stats.allTime.sessions>=100&&!t.master&&(t.master=!0,e=!0,this.showAchievement("Мастер дыхания","100 сессий дыхания завершено!")),e&&i({achievements:t})}showAchievement(t,e){const a=document.createElement("div");a.className="achievement-notification",a.innerHTML=`\n            <div class="achievement-icon">🏆</div>\n            <div class="achievement-content">\n                <div class="achievement-title">${t}</div>\n                <div class="achievement-message">${e}</div>\n            </div>\n        `,document.body.appendChild(a),setTimeout(()=>{a.classList.add("show")},100),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{document.body.removeChild(a)},300)},5e3)}};const d=new class{constructor(){this.breathCircle=document.querySelector(t.SELECTORS.BREATH_CIRCLE),this.circleText=document.querySelector(t.SELECTORS.CIRCLE_TEXT),this.phaseText=document.querySelector(t.SELECTORS.PHASE_TEXT),this.breathCounter=document.getElementById("breathCounter"),this.timerElement=document.querySelector(t.SELECTORS.TIMER),this.progressBar=document.querySelector(t.SELECTORS.PROGRESS_BAR),this.roundsDisplay=document.getElementById("roundsDisplay"),this.currentRoundElement=document.getElementById("currentRound"),this.totalRoundsElement=document.getElementById("totalRounds"),this.breathCount=0,this.currentAnimation=null,this.timerInterval=null,this.lastUpdateTime=0,this.backgroundStartTime=0,this.isInBackground=!1,this.initEventListeners(),this.setupBackgroundHandlers()}initEventListeners(){this.breathCircle&&(this.breathCircle.addEventListener("click",this.handleBreathCircleClick.bind(this)),this.breathCircle.addEventListener("touchstart",t=>{t.preventDefault(),this.handleBreathCircleClick(t)},{passive:!1})),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){e.code===t.KEY_CODES.SPACE?(e.preventDefault(),this.handleBreathCircleClick()):e.code===t.KEY_CODES.ESCAPE&&a.isBreathing&&this.pauseSession()}handleBreathCircleClick(){this.breathCircle&&(this.breathCircle.classList.add("shrink"),setTimeout(()=>{this.breathCircle&&this.breathCircle.classList.remove("shrink")},200)),a.isBreathing?"hold"===a.currentPhase?this.finishHoldingPhase():a.isPaused&&this.resumeSession():this.startSession()}startSession(){this.breathCount=0;const e=document.getElementById("progressBar");e&&(e.style.width="0%",e.style.background="linear-gradient(90deg, #4a90e2, #357abd)");const s=Math.max(1,a.rounds?.total||t.BREATHING.DEFAULT_ROUNDS);i({isBreathing:!0,isPaused:!1,currentPhase:"inhale",rounds:{...a.rounds,current:1,total:s,breathCount:0},timer:{...a.timer,startTime:Date.now(),duration:0,remainingTime:0}},!0),this.updateUI(),this.startBreathingCycle()}pauseSession(){a.isBreathing&&!a.isPaused&&(clearInterval(this.timerInterval),this.timerInterval=null,this.currentAnimation&&this.currentAnimation.pause(),i({isPaused:!0,timer:{...a.timer,remainingTime:this.getRemainingTime()}}),this.updateUI())}resumeSession(){a.isPaused&&(i({isPaused:!1,timer:{...a.timer,startTime:Date.now()-(a.timer.duration-(a.timer.remainingTime||0))}}),this.currentAnimation&&this.currentAnimation.play(),"hold"!==a.currentPhase&&this.startTimer(a.timer.duration),this.updateUI())}startBreathingCycle(){this.breathCount++,this.updateUI(),this.breathCount>30?this.startHoldingPhase():(this.breathCircle.classList.add("breathing"),this.updatePhase("inhale",t.MESSAGES.INHALE,t.BREATHING.INHALE_DURATION),this.breathCircle.classList.remove("breath-out","hold"),this.breathCircle.classList.add("breath-in"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.8},{transform:"scale(1.1)",opacity:1}],{duration:t.BREATHING.INHALE_DURATION,easing:"cubic-bezier(0.4, 0, 0.2, 1)",fill:"forwards"}),this.currentAnimation.onfinish=()=>{a.isBreathing&&!a.isPaused&&(this.updatePhase("exhale",t.MESSAGES.EXHALE,t.BREATHING.EXHALE_DURATION),this.breathCircle.classList.remove("breath-in"),this.breathCircle.classList.add("breath-out"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1.1)",opacity:1},{transform:"scale(1)",opacity:.8}],{duration:t.BREATHING.EXHALE_DURATION,easing:"cubic-bezier(0.4, 0, 0.2, 1)",fill:"forwards"}),this.currentAnimation.onfinish=()=>{a.isBreathing&&!a.isPaused&&setTimeout(()=>{a.isBreathing&&!a.isPaused&&this.startBreathingCycle()},100)})})}startHoldingPhase(){const t=Date.now(),e=36e5;i({currentPhase:"hold",isBreathing:!0,timer:{...a.timer,duration:e,startTime:t,remainingTime:e}}),this.updateUI(),this.breathCircle.classList.remove("breath-in","breath-out"),this.breathCircle.classList.add("hold");const s=document.getElementById("progressBar");s&&(s.style.width="0%",s.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)"),clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{if(!a.isPaused){const e=Date.now()-t;this.updateTimerDisplay(e)}},100),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:.9}],{duration:2e3,easing:"ease-in-out",iterations:1/0})}finishHoldingPhase(){clearInterval(this.timerInterval),this.timerInterval=null,this.currentAnimation&&this.currentAnimation.cancel(),this.startRecoveryPhase()}startRecoveryPhase(){this.updatePhase("recoveryInhale","Сделайте глубокий вдох",2e3),this.breathCircle.classList.remove("hold","breath-out"),this.breathCircle.classList.add("breath-in"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.8},{transform:"scale(1.2)",opacity:1}],{duration:2e3,easing:"ease-in-out",fill:"forwards"}),this.currentAnimation.onfinish=()=>{if(!a.isBreathing||a.isPaused)return;this.updatePhase("recoveryHold","Задержите дыхание",15e3),this.breathCircle.classList.remove("breath-in"),this.breathCircle.classList.add("hold"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:.9}],{duration:2e3,easing:"ease-in-out",iterations:1/0}),clearInterval(this.timerInterval);const t=Date.now()+15e3;this.updateTimerDisplay(15e3),this.timerInterval=setInterval(()=>{const e=Date.now(),a=Math.max(0,t-e);a<=0?(clearInterval(this.timerInterval),this.timerInterval=null,window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.HapticFeedback&&window.Telegram.WebApp.HapticFeedback.impactOccurred("medium"),this.performRecoveryExhale()):this.updateTimerDisplay(a+1e3)},50)}}performRecoveryExhale(){this.updatePhase("recoveryExhale","Медленно выдохните",2e3),this.breathCircle.classList.remove("hold","breath-in"),this.breathCircle.classList.add("breath-out"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1.2)",opacity:1},{transform:"scale(1)",opacity:.8}],{duration:2e3,easing:"ease-in-out",fill:"forwards"}),this.currentAnimation.onfinish=()=>{a.isBreathing&&!a.isPaused&&(a.rounds.current<a.rounds.total?this.startNextRound():this.finishSession())}}startNextRound(){const e=(a.rounds?.current||0)+1;if(e>(a.rounds?.total||t.BREATHING.DEFAULT_ROUNDS))return void this.finishSession();this.breathCount=0;const s=document.getElementById("progressBar");s&&(s.style.width="0%",s.style.background="linear-gradient(90deg, #4a90e2, #357abd)"),i({rounds:{...a.rounds,current:e,breathCount:0},currentPhase:"inhale",isBreathing:!0,isPaused:!1},!0),this.updateUI(),this.startBreathingCycle()}finishSession(){this.timerInterval&&(clearInterval(this.timerInterval),this.timerInterval=null),this.currentAnimation&&(this.currentAnimation.cancel(),this.currentAnimation=null);try{const t=Math.max(1,Math.floor((Date.now()-a.timer.startTime)/1e3));if(this.breathCircle){this.breathCircle.className="breath-circle";this.breathCircle.animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.95)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:1}],{duration:1e3,easing:"ease-out"}).finished.then(()=>{const e=this.updateStats(t);i({isBreathing:!1,currentPhase:"idle",timer:{...a.timer,duration:0,remainingTime:0,startTime:Date.now()},stats:e},!0);try{localStorage.setItem("lastSessionStats",JSON.stringify({timestamp:(new Date).toISOString(),duration:t,stats:e}))}catch(s){}this.updateUI(),setTimeout(()=>{this.showSessionSummary(t)},300)})}else{const e=this.updateStats(t);i({isBreathing:!1,currentPhase:"idle",timer:{...a.timer,duration:0,remainingTime:0,startTime:Date.now()},stats:e},!0),this.updateUI(),setTimeout(()=>{this.showSessionSummary(t)},300)}}catch(t){try{const e=Math.max(1,Math.floor((Date.now()-a.timer.startTime)/1e3));localStorage.setItem("errorSessionBackup",JSON.stringify({timestamp:(new Date).toISOString(),duration:e,error:t.toString()}))}catch(e){}i({isBreathing:!1,currentPhase:"idle"},!0),this.phaseText&&(this.phaseText.textContent="Ошибка при сохранении статистики")}this.breathCount=0}updateStats(t){try{("number"!=typeof t||isNaN(t)||t<=0)&&(t=1),a.stats||(a.stats={today:{},allTime:{}});const e=(new Date).toISOString().split("T")[0];a.stats.today&&a.stats.today.date===e||(a.stats.today={date:e,sessions:0,bestTime:0});const s={...a.stats.today,sessions:(a.stats.today.sessions||0)+1,bestTime:Math.max(a.stats.today.bestTime||0,t),times:[...Array.isArray(a.stats.today.times)?a.stats.today.times:[],t].filter(t=>"number"==typeof t&&!isNaN(t)&&t>0).slice(-50)};a.stats.allTime||(a.stats.allTime={sessions:0,bestTime:0,times:[],streak:0,lastPractice:null});const n=new Date,r=a.stats.allTime.lastPractice?new Date(a.stats.allTime.lastPractice):null,o=!r||r.getDate()!==n.getDate()||r.getMonth()!==n.getMonth()||r.getFullYear()!==n.getFullYear(),l={today:s,allTime:{...a.stats.allTime,sessions:(a.stats.allTime.sessions||0)+1,bestTime:Math.max(a.stats.allTime.bestTime||0,t),times:[...Array.isArray(a.stats.allTime.times)?a.stats.allTime.times:[],t].filter(t=>"number"==typeof t&&!isNaN(t)&&t>0).slice(-1e3),streak:o?(a.stats.allTime.streak||0)+1:a.stats.allTime.streak||1,lastPractice:n.toISOString()}};return i({stats:l},!0),l}catch(e){try{const e={today:{sessions:1,bestTime:t||1,times:[t||1]},allTime:{sessions:(parseInt(a.stats?.allTime?.sessions,10)||0)+1,bestTime:Math.max(parseInt(a.stats?.allTime?.bestTime,10)||0,t||1),times:[...Array.isArray(a.stats?.allTime?.times)?a.stats.allTime.times:[],t||1].filter(t=>"number"==typeof t&&!isNaN(t)&&t>0).slice(-1e3),lastPractice:(new Date).toISOString()}};return i({stats:e},!0),e}catch(s){return a.stats||{today:{},allTime:{}}}}}showSessionSummary(t){try{const i=document.getElementById("sessionCount"),n=document.getElementById("bestTime"),r=document.getElementById("sessionSummary");if(!i||!n||!r){try{alert("Ошибка при отображении статистики. Пожалуйста, проверьте консоль для подробностей.")}catch(e){}return}try{const e=a.stats?.today?.sessions||1;i.textContent=e;const s=a.stats?.today?.bestTime||t||0;n.textContent=this.formatTime(s)}catch(s){i&&(i.textContent="1"),n&&(n.textContent=this.formatTime(t||0))}try{r.classList.add("active");const t=r.querySelector(".close-button");t&&(t.onclick=()=>{r.classList.remove("active")}),r.onclick=t=>{t.target===r&&r.classList.remove("active")};const e=t=>{"Escape"===t.key&&(r.classList.remove("active"),document.removeEventListener("keydown",e))};document.addEventListener("keydown",e);const a=new MutationObserver(t=>{t.forEach(t=>{t.target.classList.contains("active")||(document.removeEventListener("keydown",e),a.disconnect())})});a.observe(r,{attributes:!0,attributeFilter:["class"]})}catch(s){}}catch(s){try{const t=document.getElementById("sessionSummary");t&&t.classList.remove("active")}catch(e){}}}updatePhase(t,e,s){i({currentPhase:t,timer:{...a.timer,duration:s||0,startTime:Date.now()}}),this.updateUI()}startTimer(t,e){clearInterval(this.timerInterval);const s=Date.now()+(t||0);this.timerInterval=setInterval(()=>{const n=Date.now(),r=Math.max(0,s-n),o=t-r;i({timer:{...a.timer,duration:t,remainingTime:r}}),this.updateTimerDisplay(o),r<=0&&(clearInterval(this.timerInterval),this.timerInterval=null,e&&e())},100)}updateTimerDisplay(t){if(!this.timerElement)return;const e=Math.floor(t/1e3),s=Math.floor(e/60),i=e%60;if(this.timerElement.textContent=`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`,this.progressBar&&"hold"!==a.currentPhase){const e=Math.min(100,t/a.timer.duration*100);this.progressBar.style.width=`${e}%`}}getRemainingTime(){return a.timer.startTime&&a.timer.duration?Math.max(0,a.timer.duration-(Date.now()-a.timer.startTime)):0}formatTime(t){const e=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}updateUI(){c&&("function"==typeof c.updateStatsDisplay&&c.updateStatsDisplay(),"function"==typeof c.updateChart&&c.updateChart()),this.phaseText&&(this.phaseText.style.opacity="0",this.phaseText.style.transform="translateY(10px)",setTimeout(()=>{this.phaseText.textContent=this.getPhaseMessage(),this.phaseText.style.opacity="0.9",this.phaseText.style.transform="translateY(0)"},150)),this.circleText&&(this.circleText.style.opacity="0",this.circleText.style.transform="scale(0.8)",setTimeout(()=>{this.circleText.textContent=this.getCircleText(),this.circleText.style.opacity="1",this.circleText.style.transform="scale(1)"},100)),this.breathCounter&&(this.breathCounter.style.display="none");const e=document.getElementById("progressBar");if(e)if(a.isBreathing)if("inhale"===a.currentPhase||"exhale"===a.currentPhase){const t=Math.min(100,this.breathCount/30*100);e.style.width=`${t}%`,"inhale"===a.currentPhase?e.style.background="linear-gradient(90deg, #4a90e2, #357abd)":"exhale"===a.currentPhase&&(e.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)")}else"recoveryInhale"===a.currentPhase||"recoveryExhale"===a.currentPhase?(e.style.width="100%","recoveryInhale"===a.currentPhase?e.style.background="linear-gradient(90deg, #4a90e2, #357abd)":e.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)"):"hold"!==a.currentPhase&&"recoveryHold"!==a.currentPhase||(e.style.width="0%",e.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)");else e.style.width="0%";if(this.currentRoundElement&&this.totalRoundsElement&&this.roundsDisplay)try{const e=Math.max(1,a.rounds?.current||1),s=Math.max(1,a.rounds?.total||t.BREATHING.DEFAULT_ROUNDS);this.currentRoundElement.textContent!==e.toString()?(this.roundsDisplay.classList.add("changing"),setTimeout(()=>{this.roundsDisplay.classList.remove("changing")},500),setTimeout(()=>{this.currentRoundElement.textContent=e,this.totalRoundsElement.textContent=s,this.roundsDisplay.classList.add("active"),setTimeout(()=>this.roundsDisplay.classList.remove("active"),300)},100)):(this.currentRoundElement.textContent=e,this.totalRoundsElement.textContent=s),this.roundsDisplay.title=`Текущий раунд: ${e} из ${s}`,this.roundsDisplay.setAttribute("aria-label",`Текущий раунд: ${e} из ${s}`)}catch(s){}if(this.breathCircle){a.isBreathing?this.breathCircle.classList.add("breathing"):this.breathCircle.classList.remove("breathing"),a.isPaused?this.breathCircle.classList.add("paused"):this.breathCircle.classList.remove("paused");["inhale","exhale","hold","recovery"].forEach(t=>{a.currentPhase===t?this.breathCircle.classList.add(t):this.breathCircle.classList.remove(t)})}}getPhaseMessage(){if(!a.isBreathing)return"Нажмите, чтобы начать";switch(a.currentPhase){case"inhale":return"Вдохните";case"exhale":return"Выдохните";case"hold":case"recoveryHold":return"Задержите дыхание";case"recoveryInhale":return"Глубокий вдох";case"recoveryExhale":return"Медленный выдох";case"paused":return"Пауза";default:return"Начать"}}getCircleText(){if(a.isPaused)return"▶";if(!a.isBreathing)return t.MESSAGES.START;switch(a.currentPhase){case"hold":case"finalHold":case"recoveryHold":return"👃";case"recoveryInhale":return"⬆️";case"recoveryExhale":return"⬇️";case"inhale":case"exhale":return this.breathCount>0?this.breathCount:a.rounds.current;case"recovery":return"♻️";default:return a.rounds.current}}setupBackgroundHandlers(){}};const u=new class{constructor(){this.player=null,this.isPlayerReady=!1,this.playlist=[],this.currentTrackIndex=0,this.initYouTubePlayer()}initYouTubePlayer(){if("undefined"==typeof YT||void 0===YT.Player){const t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";const e=document.getElementsByTagName("script")[0];return e.parentNode.insertBefore(t,e),void setTimeout(()=>this.initYouTubePlayer(),2e3)}try{this.player=new YT.Player(t.SELECTORS.YOUTUBE_PLAYER,{height:"0",width:"0",playerVars:t.YOUTUBE.PLAYER_VARS,events:{onReady:this.onPlayerReady.bind(this),onStateChange:this.onPlayerStateChange.bind(this),onError:this.onPlayerError.bind(this)}})}catch(e){}}onPlayerReady(t){this.isPlayerReady=!0;try{this.setVolume(50),this.play(),i({music:{...a.music,isPlaying:!0}})}catch(e){}}onPlayerStateChange(e){const s=document.querySelector(t.SELECTORS.MUSIC_CONTROL);s&&(e.data===YT.PlayerState.PLAYING?(s.classList.add("playing"),s.innerHTML='<span style="transform: scale(0.8);">⏸</span>',i({music:{...a.music,isPlaying:!0}})):e.data!==YT.PlayerState.PAUSED&&e.data!==YT.PlayerState.ENDED||(s.classList.remove("playing"),s.innerHTML='<span style="transform: scale(1.2);">🎵</span>',i({music:{...a.music,isPlaying:!1}}),e.data===YT.PlayerState.ENDED&&this.playNext()))}onPlayerError(t){2!==t.data&&100!==t.data&&101!==t.data&&150!==t.data||this.playNext()}async loadPlaylist(){if(this.isPlayerReady)try{const e=await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${t.YOUTUBE.PLAYLIST_ID}&key=YOUR_YOUTUBE_API_KEY`),s=await e.json();s.items&&s.items.length>0&&(this.playlist=s.items.map(t=>({id:t.snippet.resourceId.videoId,title:t.snippet.title,thumbnail:t.snippet.thumbnails.default.url})),null===a.music.currentTrack&&this.playlist.length>0&&(this.currentTrackIndex=Math.floor(Math.random()*this.playlist.length),i({music:{...a.music,currentTrack:this.playlist[this.currentTrackIndex]}})))}catch(e){}}togglePlay(){window.app&&window.app.youTubePlayer?a.music.isPlaying?(window.app.youTubePlayer.pauseVideo(),i({music:{...a.music,isPlaying:!1}})):(window.app.youTubePlayer.playVideo(),i({music:{...a.music,isPlaying:!0}})):window.app&&window.app.initializeYouTubePlayer()}play(){window.app&&window.app.youTubePlayer?a.music.currentTrack?(window.app.youTubePlayer.playVideo(),i({music:{...a.music,isPlaying:!0}})):this.playlist.length>0?(this.currentTrackIndex=Math.floor(Math.random()*this.playlist.length),i({music:{...a.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"})):this.loadPlaylist().then(()=>{this.playlist.length>0&&this.play()}):window.app&&window.app.initializeYouTubePlayer()}pause(){window.app&&window.app.youTubePlayer&&(window.app.youTubePlayer.pauseVideo(),i({music:{...a.music,isPlaying:!1}}))}playNext(){return window.app&&window.app.youTubePlayer?0===this.playlist.length?this.loadPlaylist().then(()=>{this.playlist.length>0&&this.playNext()}):(this.currentTrackIndex=(this.currentTrackIndex+1)%this.playlist.length,i({music:{...a.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"}),Promise.resolve()):Promise.reject("YouTube Player не инициализирован")}playPrevious(){return window.app&&window.app.youTubePlayer?0===this.playlist.length?this.loadPlaylist().then(()=>{this.playlist.length>0&&this.playPrevious()}):(this.currentTrackIndex=(this.currentTrackIndex-1+this.playlist.length)%this.playlist.length,i({music:{...a.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"}),Promise.resolve()):Promise.reject("YouTube Player не инициализирован")}setVolume(t){if(window.app&&window.app.youTubePlayer){const e=Math.max(0,Math.min(100,t));window.app.youTubePlayer.setVolume(e),i({settings:{...a.settings,volume:e/100}})}}toggleMute(){if(window.app&&window.app.youTubePlayer){const t=!a.music.isMuted;t?window.app.youTubePlayer.mute():window.app.youTubePlayer.unMute(),i({music:{...a.music,isMuted:t}})}}getCurrentTrack(){return a.music.currentTrack}getPlaylist(){return[...this.playlist]}};function h(t){const e=document.getElementById("settingsPanel"),a=document.getElementById("openSettings"),s=document.getElementById("closeSettings"),i=document.getElementById("saveSettings"),n=document.getElementById("cancelSettings"),r=document.getElementById("roundsSetting"),o=document.getElementById("roundsValue"),l=document.getElementById("breathCountSetting"),c=document.getElementById("breathCountValue"),d=document.getElementById("darkModeToggle"),u=document.getElementById("volumeSetting"),h=document.getElementById("volumeValue"),m=document.getElementById("soundEffectsToggle"),p=document.getElementById("voicePromptsToggle"),y=document.getElementById("languageSelect"),g=document.getElementById("resetStats"),T=document.getElementById("exportData");let f=!1,E={};function S(){const{settings:e}=t.getState();E={...e},e&&(void 0!==e.rounds&&(r.value=e.rounds,o.textContent=e.rounds),void 0!==e.breathCount&&(l.value=e.breathCount,c.textContent=e.breathCount),void 0!==e.darkMode&&(d.checked=e.darkMode,document.documentElement.setAttribute("data-theme",e.darkMode?"dark":"light")),void 0!==e.volume&&(u.value=e.volume,h.textContent=`${e.volume}%`,window.musicManager&&window.musicManager.setVolume(e.volume/100)),void 0!==e.soundEffects&&(m.checked=e.soundEffects),void 0!==e.voicePrompts&&(p.checked=e.voicePrompts),e.language&&(y.value=e.language))}function b(){f=!1,i&&(i.disabled=!0),S(),e.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden";const t=e.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t&&t.focus(),document.addEventListener("touchstart",v,{passive:!0})}function v(t){if(e&&!e.contains(t.target)&&t.target!==a&&!a.contains(t.target)){const t=document.activeElement;!t||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName||t.blur()}}function I(){if(C(),e.setAttribute("aria-hidden","true"),document.body.style.overflow="",document.removeEventListener("touchstart",v,{passive:!0}),f){if(!confirm("У вас есть несохраненные изменения. Вы уверены, что хотите закрыть?"))return e.setAttribute("aria-hidden","false"),void document.addEventListener("touchstart",v,{passive:!0})}S(),a?.focus()}function w(){f=!0,i&&(i.disabled=!1)}a?.addEventListener("click",t=>{t.preventDefault(),b()}),s?.addEventListener("click",I),n?.addEventListener("click",I),i?.addEventListener("click",function(){const e={...E,rounds:parseInt(r.value,10)||3,breathCount:parseInt(l.value,10)||30,darkMode:d.checked,volume:parseInt(u.value,10)||50,soundEffects:m.checked,voicePrompts:p.checked,language:y.value||"ru",lastUpdated:(new Date).toISOString()};JSON.stringify(e)!==JSON.stringify(E)&&(t.dispatch({type:"UPDATE_SETTINGS",payload:e}),document.documentElement.setAttribute("data-theme",e.darkMode?"dark":"light"),window.musicManager&&void 0!==e.volume&&window.musicManager.setVolume(e.volume/100)),I()}),e?.addEventListener("click",t=>{(t.target===e||t.target.classList.contains("settings-overlay"))&&I()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&"false"===e?.getAttribute("aria-hidden")&&I()});[r,l,d,u,m,p,y].forEach(t=>{t&&(t.addEventListener("change",w),"range"===t.type&&t.addEventListener("input",w))});const A=document.getElementById("roundsNumberInput");function C(){window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.isExpanded&&(document.activeElement&&document.activeElement.blur&&document.activeElement.blur(),window.Telegram.WebApp.HapticFeedback.impactOccurred("light"),setTimeout(()=>{const t=document.createElement("div");t.tabIndex=-1,document.body.appendChild(t),t.focus(),document.body.removeChild(t)},50))}function P(t){const e=parseInt(t,10);if(!isNaN(e)){if(C(),r){r.value=e;const t=new Event("input",{bubbles:!0});r.dispatchEvent(t)}A&&(A.value=e),o&&(o.textContent=e);const t=document.querySelector(".rounds-display"),a=document.getElementById("currentRound"),s=document.getElementById("totalRounds");if(t&&a&&s){s.textContent=e;const i=Math.min(parseInt(a.textContent,10)||1,e);a.textContent=i,t.title=`Текущий раунд: ${i} из ${e}`,t.setAttribute("aria-label",`Текущий раунд: ${i} из ${e}`),t.offsetHeight}const i=Math.min(state.rounds?.current||1,e);if(updateState({rounds:{...state.rounds,total:e,current:i},settings:{...state.settings,rounds:e}},!0),window.breathingManager&&"function"==typeof window.breathingManager.updateUI&&setTimeout(()=>{window.breathingManager.updateUI();const t=document.querySelector(".rounds-display"),a=document.getElementById("currentRound"),s=document.getElementById("totalRounds");t&&a&&s&&(a.textContent=i,s.textContent=e,t.classList.remove("changing","active"),t.title=`Текущий раунд: ${i} из ${e}`,t.setAttribute("aria-label",`Текущий раунд: ${i} из ${e}`),t.offsetHeight,t.style.display="none",t.offsetHeight,t.style.display="")},0),window.breathingManager){const t=state.currentPhase;if(t&&"idle"!==t){const e=t;updateState({currentPhase:"refreshing",forceUpdate:!0},!0),setTimeout(()=>{updateState({currentPhase:e,forceUpdate:!0},!0),window.breathingManager.updateUI()},100)}else window.breathingManager.updateUI()}const n=window.app||window.appInstance;n&&"function"==typeof n.updateUI&&n.updateUI(),w()}}r?.addEventListener("input",t=>{P(t.target.value)}),A&&(A.addEventListener("input",t=>{let e=t.target.value;if(e=e.replace(/\D/g,""),t.target.value=e,""===e)return void P(1);const a=parseInt(e,10);isNaN(a)||a<1?P(1):P(a>10?10:a)}),A.addEventListener("blur",t=>{""===t.target.value&&(t.target.value=1,P(1))}),A.addEventListener("keypress",t=>{"Enter"!==t.key&&13!==t.keyCode||(t.preventDefault(),A.blur())}),A.addEventListener("blur",()=>{setTimeout(()=>{A.scrollIntoView({behavior:"smooth",block:"center"})},100)}),A.value=r?.value||3),l?.addEventListener("input",t=>{c.textContent=t.target.value,w()}),u?.addEventListener("input",t=>{h.textContent=`${t.target.value}%`,w(),window.musicManager&&window.musicManager.setVolume(t.target.value/100)}),g?.addEventListener("click",()=>{confirm("Вы уверены, что хотите сбросить всю статистику? Это действие нельзя отменить.")&&(t.dispatch({type:"RESET_STATS"}),alert("Статистика успешно сброшена."))}),T?.addEventListener("click",()=>{const e=t.getState(),a=JSON.stringify(e,null,2),s="data:application/json;charset=utf-8,"+encodeURIComponent(a),i=`wim-hof-data-${(new Date).toISOString().split("T")[0]}.json`,n=document.createElement("a");n.setAttribute("href",s),n.setAttribute("download",i),n.click()});const k=document.getElementById("resetDefaults");return k?.addEventListener("click",()=>{confirm("Вы уверены, что хотите сбросить все настройки к значениям по умолчанию?")&&(t.dispatch({type:"RESET_SETTINGS"}),S(),function(t,e="success"){const a=document.querySelector(".settings-message");a&&a.remove();const s=document.createElement("div");s.className=`settings-message ${e}`,s.textContent=t,document.body.appendChild(s),setTimeout(()=>{s.parentNode===document.body&&(s.style.opacity="0",s.style.transform="translate(-50%, -20px)",setTimeout(()=>{s.parentNode===document.body&&document.body.removeChild(s)},300))},3e3)}("Настройки сброшены к значениям по умолчанию","success"),w())}),S(),{openSettings:b,closeSettings:I,loadSettings:S}}window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,(new Date).toISOString();class m{constructor(){this.isAdjusting=!1,this.youTubePlayer=null,window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this)),l(),this.initEventListeners(),this.initTheme(),this.initTutorial(),this.updateUI(),this.initializeYouTubePlayer(),this.settingsManager=h({getState:()=>a,dispatch:t=>{"UPDATE_SETTINGS"===t.type&&(i({settings:t.payload}),document.documentElement.setAttribute("data-theme",t.payload.darkMode?"dark":"light"))}}),c&&(c.init(),c.updateStatsDisplay(),setTimeout(()=>{c.updateChart()},500))}handleBeforeUnload(){i({},!0)}initializeYouTubePlayer(){if(!this.youTubePlayer)try{this.youTubePlayer=new YT.Player("youtubePlayer",{height:"0",width:"0",playerVars:{...t.YOUTUBE.PLAYER_VARS,enablejsapi:1,origin:window.location.origin},events:{onReady:()=>{a.music.isPlaying&&this.youTubePlayer.playVideo()},onStateChange:e=>{const s=document.querySelector(t.SELECTORS.MUSIC_CONTROL);s&&(e.data===YT.PlayerState.PLAYING?(s.classList.add("playing"),s.innerHTML='<span style="transform: scale(0.8);">⏸</span>',i({music:{...a.music,isPlaying:!0}})):e.data!==YT.PlayerState.PAUSED&&e.data!==YT.PlayerState.ENDED||(s.classList.remove("playing"),s.innerHTML='<span style="transform: scale(1.2);">🎵</span>',i({music:{...a.music,isPlaying:!1}})))},onError:t=>{}}})}catch(e){}}initEventListeners(){document.querySelectorAll(".stats-tab").forEach(t=>{t.addEventListener("click",t=>this.handleStatsTabClick(t))});const e=document.getElementById("roundsInput");e&&e.addEventListener("change",e=>{let s=parseInt(e.target.value,10);isNaN(s)||s<t.BREATHING.MIN_ROUNDS?s=t.BREATHING.MIN_ROUNDS:s>t.BREATHING.MAX_ROUNDS&&(s=t.BREATHING.MAX_ROUNDS),i({rounds:{...a.rounds,total:s}}),e.target.value=s});const s=document.querySelector(".rounds-display");s&&(s.addEventListener("click",()=>{const s=prompt("Введите количество раундов (1-10):",a.rounds.total);if(null!==s){let n=parseInt(s,10);isNaN(n)||n<t.BREATHING.MIN_ROUNDS?n=t.BREATHING.MIN_ROUNDS:n>t.BREATHING.MAX_ROUNDS&&(n=t.BREATHING.MAX_ROUNDS),i({rounds:{...a.rounds,total:n}}),e&&(e.value=n)}}),s.style.cursor="pointer");const n=document.getElementById("musicControl");n&&n.addEventListener("click",()=>u.togglePlay());const r=document.getElementById("closeTutorial");r&&r.addEventListener("click",()=>this.hideTutorial()),document.querySelectorAll('input[type="range"]').forEach(t=>{this.updateRangeProgress(t),t.addEventListener("input",t=>this.updateRangeProgress(t.target))})}updateRangeProgress(t){const e=t.value,a=t.min||0,s=(e-a)/((t.max||100)-a)*100;t.style.setProperty("--range-progress",`${s}%`)}initTheme(){document.documentElement.setAttribute("data-theme","light"),this.settingsManager&&this.settingsManager.dispatch&&this.settingsManager.dispatch({type:"UPDATE_SETTINGS",payload:{...a.settings,darkMode:!1,lastUpdated:(new Date).toISOString()}})}initTutorial(){if(this.currentTutorialStep=0,this.tutorialSteps=[{title:"Добро пожаловать!",content:"Это приложение поможет вам освоить технику дыхания Вим Хофа. Давайте начнем!"},{title:"Как это работает",content:"1. Сделайте 30 глубоких вдохов и выдохов\n2. После последнего выдоха задержите дыхание\n3. После задержки сделайте глубокий вдох и задержите дыхание на 15 секунд"},{title:"Готовы начать?",content:'Нажмите "Готово" чтобы приступить к практике.'}],!a.tutorial.isCompleted){this.showTutorial(),this.updateTutorialStep(0);const t=document.getElementById("prevStep"),e=document.getElementById("nextStep");t&&e&&(t.addEventListener("click",()=>this.prevTutorialStep()),e.addEventListener("click",()=>this.nextTutorialStep()))}}showTutorial(){const t=document.getElementById("tutorial");t&&(t.style.display="flex",setTimeout(()=>{t.classList.add("show")},100))}updateTutorialStep(t){this.currentTutorialStep=t;const e=document.getElementById("tutorial"),a=document.getElementById("tutorialTitle"),s=document.getElementById("tutorialContent"),i=document.getElementById("prevStep"),n=document.getElementById("nextStep"),r=document.querySelector(".step-indicators");e&&a&&s&&i&&n&&r&&(a.textContent=this.tutorialSteps[t].title,s.innerHTML=this.tutorialSteps[t].content.replace(/\n/g,"<br>"),i.disabled=0===t,n.textContent=t===this.tutorialSteps.length-1?"Готово":"Далее",r.innerHTML="",this.tutorialSteps.forEach((e,a)=>{const s=document.createElement("div");s.className="step-indicator "+(a===t?"active":""),s.addEventListener("click",()=>this.updateTutorialStep(a)),r.appendChild(s)}))}nextTutorialStep(){this.currentTutorialStep<this.tutorialSteps.length-1?this.updateTutorialStep(this.currentTutorialStep+1):this.hideTutorial()}prevTutorialStep(){this.currentTutorialStep>0&&this.updateTutorialStep(this.currentTutorialStep-1)}hideTutorial(){const t=document.getElementById("tutorial");t&&(t.classList.remove("show"),setTimeout(()=>{t.style.display="none",i({tutorial:{...a.tutorial,isCompleted:!0}})},300))}adjustRounds(e){if(this.isAdjusting)return;this.isAdjusting=!0,setTimeout(()=>{this.isAdjusting=!1},300);const s=a.rounds.total+e;s>=t.BREATHING.MIN_ROUNDS&&s<=t.BREATHING.MAX_ROUNDS&&(i({rounds:{...a.rounds,total:s}}),this.updateUI())}handleStatsTabClick(t){const e=t.currentTarget,a=e.dataset.tab;document.querySelectorAll(".stats-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".stats-content").forEach(t=>{t.style.display="none"});const s=`stats${a.charAt(0).toUpperCase()+a.slice(1)}`,i=document.getElementById(s);i&&(i.style.display="block")}updateUI(){const e=document.getElementById("roundsInput");e&&(e.value=a.rounds.total);const s=document.querySelector(".rounds-display");if(s){const e=s.querySelector("#currentRound");e&&(e.textContent=a.rounds.current);const i=s.querySelector("#totalRounds");i&&(i.textContent=a.rounds.total);const n=a.rounds.current||1,r=a.rounds.total||t.BREATHING.DEFAULT_ROUNDS;s.title=`Текущий раунд: ${n} из ${r}`,s.setAttribute("aria-label",`Текущий раунд: ${n} из ${r}`)}const i=document.getElementById("themeIcon");i&&(i.textContent=a.settings.darkMode?"☀️":"🌙")}}function p(t){try{const e=window.Telegram?.WebApp?.version||"1.0",[a]=e.split(".").map(Number),s={BackButton:6.1,HapticFeedback:6.1,enableClosingConfirmation:6.2}[t]||0;return parseFloat(e)>=s}catch(e){return!1}}function y(){const t=new m;window.app=t,window.breathingManager=d;const e=document.getElementById("loader");return e&&(e.style.display="none"),window.Telegram&&window.Telegram.WebApp&&function(){try{if(!window.Telegram?.WebApp)return!1;const e=window.Telegram.WebApp;e.expand();try{e.setBackgroundColor("#ffffff")}catch(t){}if(p("enableClosingConfirmation"))try{e.enableClosingConfirmation()}catch(t){}if(p("HapticFeedback")&&e.HapticFeedback)try{e.HapticFeedback.impactOccurred("light")}catch(t){}if(p("BackButton")&&e.BackButton)try{e.BackButton.show(),e.BackButton.onClick(()=>{a.isBreathing?d.pauseSession():e.close()})}catch(t){}return!0}catch(e){return!1}}(),t}document.addEventListener("DOMContentLoaded",()=>{try{window.app||(window.app=new m,window.appInstance=window.app)}catch(t){const e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.right="0",e.style.padding="20px",e.style.backgroundColor="#ffebee",e.style.color="#c62828",e.style.zIndex="1000",e.style.textAlign="center",e.textContent="Произошла ошибка при загрузке приложения. Пожалуйста, обновите страницу.",document.body.prepend(e)}}),document.addEventListener("DOMContentLoaded",()=>{try{window.app=y(),window.appInitialized=!0,window.YTReady&&window.app.initializeYouTubePlayer()}catch(t){const e=document.querySelector(".app-container");e&&(e.innerHTML=`\n                        <div class="error-container" style="padding: 2rem; text-align: center;">\n                            <h2>Произошла ошибка</h2>\n                            <p>Не удалось загрузить приложение. Пожалуйста, попробуйте перезагрузить страницу.</p>\n                            <p>Если проблема сохраняется, свяжитесь с поддержкой.</p>\n                            <p style="color: #e74c3c; font-size: 0.9rem; margin-top: 1rem;">${t.message}</p>\n                        </div>\n                    `)}});
