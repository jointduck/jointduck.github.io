!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const a of t)if("childList"===a.type)for(const t of a.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const t={BREATHING:{DEFAULT_ROUNDS:3,MIN_ROUNDS:1,MAX_ROUNDS:10,BREATHS_PER_ROUND:30,INHALE_DURATION:2e3,EXHALE_DURATION:2e3,HOLD_DURATION:15e3,RECOVERY:{INHALE:2e3,HOLD:15e3,EXHALE:2e3},FINAL_RECOVERY:{INHALE:2e3,HOLD:15e3,EXHALE:2e3}},YOUTUBE:{PLAYLIST_ID:"PLstkrDtqpxiIWWU4ctz1Hg_U_XpUo5zr4",PLAYER_VARS:{autoplay:1,controls:0,disablekb:1,fs:0,modestbranding:1,playsinline:1,playlist:"PLstkrDtqpxiIWWU4ctz1Hg_U_XpUo5zr4",enablejsapi:1,origin:window.location.origin}},ANIMATIONS:{BREATH_IN:"breathIn",BREATH_OUT:"breathOut",PULSE:"pulse"},CLASSES:{ACTIVE:"active",PLAYING:"playing",HIDDEN:"hidden"},SELECTORS:{BREATH_CIRCLE:"#breathCircle",CIRCLE_TEXT:"#circleText",PHASE_TEXT:"#phaseText",TIMER:"#timer",PROGRESS_BAR:"#progressBar",ROUNDS_COUNT:"#roundsCount",CURRENT_ROUND:"#currentRound",TOTAL_ROUNDS:"#totalRounds",MUSIC_CONTROL:"#musicControl",YOUTUBE_PLAYER:"#youtubePlayer",LOADER:"#loader",TUTORIAL:"#tutorial",TUTORIAL_CLOSE:"#closeTutorial"},MESSAGES:{START:"Начать",INHALE:"Вдох",EXHALE:"Выдох",HOLD:"Задержка",RECOVERY:"Восстановление",FINAL_HOLD:"Финальная задержка",FINISH:"Завершено",PRESS_TO_START:"Нажмите, чтобы начать",PRESS_TO_CONTINUE:"Нажмите, чтобы продолжить"},KEY_CODES:{SPACE:"Space",ESCAPE:"Escape",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight"},I18N:{ru:{start:"Начать",inhale:"Вдох",exhale:"Выдох",hold:"Задержка",recovery:"Восстановление",round:"Раунд",of:"из",today:"Сегодня",allTime:"Все время",sessions:"Сессий",bestTime:"Лучшее время",avgTime:"Среднее время",streak:"Дней подряд",achievements:"Достижения"},en:{start:"Start",inhale:"Inhale",exhale:"Exhale",hold:"Hold",recovery:"Recovery",round:"Round",of:"of",today:"Today",allTime:"All Time",sessions:"Sessions",bestTime:"Best Time",avgTime:"Average Time",streak:"Day Streak",achievements:"Achievements"}}};let e={...{isBreathing:!1,isPaused:!1,currentPhase:"idle",rounds:{current:0,total:t.BREATHING.DEFAULT_ROUNDS,breathCount:0},timer:{startTime:null,duration:0,interval:null,remainingTime:0},settings:{soundEnabled:!0,hapticFeedback:!0,darkMode:window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,language:"ru"},music:{isPlaying:!1,isMuted:!1,volume:.5,currentTrack:null,player:null},stats:{today:{sessions:0,bestTime:0,times:[]},allTime:{sessions:0,bestTime:0,times:[],streak:0,lastPractice:null}},achievements:{firstSession:!1,weekStreak:!1,monthStreak:!1,master:!1},tutorial:{isCompleted:!1,currentStep:0,steps:["Добро пожаловать в приложение для дыхания по методу Вим Хофа!","Настройте количество раундов с помощью кнопок + и -","Нажмите на круг, чтобы начать сессию","Следуйте инструкциям на экране: Вдох - Задержка - Выдох","Наслаждайтесь процессом и дышите осознанно!"]}}};const a=[];function s(t,a=!1){e={...e,...t},i(),(a||void 0!==t.isBreathing||void 0!==t.currentPhase||void 0!==t.rounds||void 0!==t.stats)&&function(){try{const t={settings:e.settings,stats:e.stats,achievements:e.achievements,tutorial:e.tutorial,rounds:e.rounds};localStorage.setItem("whmAppState",JSON.stringify(t))}catch(t){}}()}function i(){a.forEach(t=>t(e))}function r(){!function(){try{const t=localStorage.getItem("whmAppState");if(t){const a=JSON.parse(t);e={...e,settings:{...e.settings,...a.settings||{}},stats:{...e.stats,...a.stats||{}},achievements:{...e.achievements,...a.achievements||{}},tutorial:{...e.tutorial,...a.tutorial||{}},rounds:{...e.rounds,...a.rounds||{}}},i()}}catch(t){}}(),e.rounds.current=1,e.tutorial.isCompleted||(e.tutorial.isActive=!0),document.documentElement.setAttribute("data-theme",e.settings.darkMode?"dark":"light"),function(){const t=new Date(e.stats.allTime.lastPractice),a=new Date,i=new Date(a);i.setDate(i.getDate()-1),t&&t.getDate()!==i.getDate()&&t.getDate()!==a.getDate()&&s({stats:{...e.stats,allTime:{...e.stats.allTime,streak:0}}})}(),s({},!0)}new class{constructor(){this.animations=new Map,this.initAnimations()}initAnimations(){this.defineAnimation("breathIn",{keyframes:[{transform:"scale(1)",opacity:.8},{transform:"scale(1.2)",opacity:1}],options:{duration:4e3,easing:"ease-in-out",fill:"forwards"}}),this.defineAnimation("breathOut",{keyframes:[{transform:"scale(1.2)",opacity:1},{transform:"scale(1)",opacity:.8}],options:{duration:8e3,easing:"ease-in-out",fill:"forwards"}}),this.defineAnimation("pulse",{keyframes:[{transform:"scale(1)"},{transform:"scale(1.05)"},{transform:"scale(1)"}],options:{duration:1500,easing:"ease-in-out",iterations:1/0}})}defineAnimation(t,{keyframes:e,options:a}){this.animations.set(t,{keyframes:e,options:a})}animate(t,e,a=null){if(!t)return null;this.stopAnimation(t);const s=this.animations.get(e);if(!s)return null;const i=t.animate(s.keyframes,s.options);return a&&(i.onfinish=a),t.dataset.currentAnimation=e,i}stopAnimation(t){if(!t)return;t.getAnimations().forEach(t=>{t.cancel()}),delete t.dataset.currentAnimation}breathIn(t,e=4e3){return this.animate(t,"breathIn",{duration:e,easing:"ease-in-out",fill:"forwards"})}breathOut(t,e=8e3){return this.animate(t,"breathOut",{duration:e,easing:"ease-in-out",fill:"forwards"})}pulse(t){return this.animate(t,"pulse")}fadeIn(t,e=300){return t.style.opacity="0",t.style.display="block",this.animate(t,{keyframes:[{opacity:0},{opacity:1}],options:{duration:e,easing:"ease-in-out",fill:"forwards"}})}fadeOut(t,e=300){return new Promise(a=>{this.animate(t,{keyframes:[{opacity:1},{opacity:0}],options:{duration:e,easing:"ease-in-out",fill:"forwards"}}).onfinish=()=>{t.style.display="none",a()}})}};const n=new class{constructor(){this.breathCircle=document.querySelector(t.SELECTORS.BREATH_CIRCLE),this.circleText=document.querySelector(t.SELECTORS.CIRCLE_TEXT),this.phaseText=document.querySelector(t.SELECTORS.PHASE_TEXT),this.breathCounter=document.getElementById("breathCounter"),this.timerElement=document.querySelector(t.SELECTORS.TIMER),this.progressBar=document.querySelector(t.SELECTORS.PROGRESS_BAR),this.currentRoundElement=document.querySelector(t.SELECTORS.CURRENT_ROUND),this.totalRoundsElement=document.querySelector(t.SELECTORS.TOTAL_ROUNDS),this.breathCount=0,this.currentAnimation=null,this.timerInterval=null,this.lastUpdateTime=0,this.backgroundStartTime=0,this.isInBackground=!1,this.initEventListeners(),this.setupBackgroundHandlers()}initEventListeners(){this.breathCircle&&(this.breathCircle.addEventListener("click",this.handleBreathCircleClick.bind(this)),this.breathCircle.addEventListener("touchstart",t=>{t.preventDefault(),this.handleBreathCircleClick(t)},{passive:!1})),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(a){a.code===t.KEY_CODES.SPACE?(a.preventDefault(),this.handleBreathCircleClick()):a.code===t.KEY_CODES.ESCAPE&&e.isBreathing&&this.pauseSession()}handleBreathCircleClick(){e.isBreathing?"hold"===e.currentPhase?this.finishHoldingPhase():e.isPaused&&this.resumeSession():this.startSession()}startSession(){this.breathCount=0;const t=document.getElementById("progressBar");t&&(t.style.width="0%",t.style.background="linear-gradient(90deg, #4a90e2, #357abd)"),s({isBreathing:!0,currentPhase:"inhale",rounds:{...e.rounds,current:1,breathCount:0},timer:{...e.timer,startTime:Date.now(),duration:0}}),this.updateUI(),this.startBreathingCycle()}pauseSession(){e.isBreathing&&!e.isPaused&&(clearInterval(this.timerInterval),this.timerInterval=null,this.currentAnimation&&this.currentAnimation.pause(),s({isPaused:!0,timer:{...e.timer,remainingTime:this.getRemainingTime()}}),this.updateUI())}resumeSession(){e.isPaused&&(s({isPaused:!1,timer:{...e.timer,startTime:Date.now()-(e.timer.duration-(e.timer.remainingTime||0))}}),this.currentAnimation&&this.currentAnimation.play(),"hold"!==e.currentPhase&&this.startTimer(e.timer.duration),this.updateUI())}startBreathingCycle(){this.breathCount++,this.updateUI(),this.breathCount>30?this.startHoldingPhase():(this.breathCircle.classList.add("breathing"),this.updatePhase("inhale",t.MESSAGES.INHALE,t.BREATHING.INHALE_DURATION),this.breathCircle.classList.remove("breath-out","hold"),this.breathCircle.classList.add("breath-in"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.8},{transform:"scale(1.1)",opacity:1}],{duration:t.BREATHING.INHALE_DURATION,easing:"cubic-bezier(0.4, 0, 0.2, 1)",fill:"forwards"}),this.currentAnimation.onfinish=()=>{e.isBreathing&&!e.isPaused&&(this.updatePhase("exhale",t.MESSAGES.EXHALE,t.BREATHING.EXHALE_DURATION),this.breathCircle.classList.remove("breath-in"),this.breathCircle.classList.add("breath-out"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1.1)",opacity:1},{transform:"scale(1)",opacity:.8}],{duration:t.BREATHING.EXHALE_DURATION,easing:"cubic-bezier(0.4, 0, 0.2, 1)",fill:"forwards"}),this.currentAnimation.onfinish=()=>{e.isBreathing&&!e.isPaused&&setTimeout(()=>{e.isBreathing&&!e.isPaused&&this.startBreathingCycle()},100)})})}startHoldingPhase(){const t=Date.now(),a=36e5;s({currentPhase:"hold",isBreathing:!0,timer:{...e.timer,duration:a,startTime:t,remainingTime:a}}),this.updateUI(),this.breathCircle.classList.remove("breath-in","breath-out"),this.breathCircle.classList.add("hold");const i=document.getElementById("progressBar");i&&(i.style.width="0%",i.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)"),clearInterval(this.timerInterval),this.timerInterval=setInterval(()=>{if(!e.isPaused){const e=Date.now()-t;this.updateTimerDisplay(e)}},100),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:.9}],{duration:2e3,easing:"ease-in-out",iterations:1/0})}finishHoldingPhase(){clearInterval(this.timerInterval),this.timerInterval=null,this.currentAnimation&&this.currentAnimation.cancel(),this.startRecoveryPhase()}startRecoveryPhase(){this.updatePhase("recoveryInhale","Сделайте глубокий вдох",2e3),this.breathCircle.classList.remove("hold","breath-out"),this.breathCircle.classList.add("breath-in"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.8},{transform:"scale(1.2)",opacity:1}],{duration:2e3,easing:"ease-in-out",fill:"forwards"}),this.currentAnimation.onfinish=()=>{if(!e.isBreathing||e.isPaused)return;this.updatePhase("recoveryHold","Задержите дыхание",15e3),this.breathCircle.classList.remove("breath-in"),this.breathCircle.classList.add("hold"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:.9}],{duration:2e3,easing:"ease-in-out",iterations:1/0}),clearInterval(this.timerInterval);const t=Date.now()+15e3;this.updateTimerDisplay(15e3),this.timerInterval=setInterval(()=>{const e=Date.now(),a=Math.max(0,t-e);a<=0?(clearInterval(this.timerInterval),this.timerInterval=null,window.Telegram&&window.Telegram.WebApp&&window.Telegram.WebApp.HapticFeedback&&window.Telegram.WebApp.HapticFeedback.impactOccurred("medium"),this.performRecoveryExhale()):this.updateTimerDisplay(a+1e3)},50)}}performRecoveryExhale(){this.updatePhase("recoveryExhale","Медленно выдохните",2e3),this.breathCircle.classList.remove("hold","breath-in"),this.breathCircle.classList.add("breath-out"),this.currentAnimation=this.breathCircle.animate([{transform:"scale(1.2)",opacity:1},{transform:"scale(1)",opacity:.8}],{duration:2e3,easing:"ease-in-out",fill:"forwards"}),this.currentAnimation.onfinish=()=>{e.isBreathing&&!e.isPaused&&(e.rounds.current<e.rounds.total?this.startNextRound():this.finishSession())}}startNextRound(){if(e.rounds.current>=e.rounds.total)return void this.finishSession();this.breathCount=0;const t=document.getElementById("progressBar");t&&(t.style.width="0%",t.style.background="linear-gradient(90deg, #4a90e2, #357abd)"),s({rounds:{...e.rounds,current:e.rounds.current+1,breathCount:0},currentPhase:"inhale",isBreathing:!0}),this.startBreathingCycle()}finishSession(){clearInterval(this.timerInterval),this.timerInterval=null;const t=Math.floor((Date.now()-e.timer.startTime)/1e3);this.currentAnimation&&(this.currentAnimation.cancel(),this.currentAnimation=null),this.breathCircle&&(this.breathCircle.className="breath-circle",this.breathCircle.animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.95)",opacity:.9},{transform:"scale(1.05)",opacity:1},{transform:"scale(1)",opacity:1}],{duration:1e3,easing:"ease-out"}));const a=this.updateStats(t);s({isBreathing:!1,currentPhase:"idle",timer:{...e.timer,duration:0,remainingTime:0,startTime:Date.now()},stats:a},!0),this.updateUI(),this.showSessionSummary(t),this.breathCount=0}updateStats(t){const a=new Date;a.toISOString().split("T")[0];const s=new Date(e.stats.allTime.lastPractice||0),i=!e.stats.allTime.lastPractice||s.toDateString()!==a.toDateString();return{today:{...e.stats.today,sessions:e.stats.today.sessions+1,bestTime:Math.max(e.stats.today.bestTime,t),times:[...e.stats.today.times,t].slice(-50)},allTime:{...e.stats.allTime,sessions:e.stats.allTime.sessions+1,bestTime:Math.max(e.stats.allTime.bestTime,t),times:[...e.stats.allTime.times,t].slice(-1e3),streak:i?e.stats.allTime.streak+1:e.stats.allTime.streak,lastPractice:a.toISOString()}}}showSessionSummary(t){}updatePhase(t,a,i){s({currentPhase:t,timer:{...e.timer,duration:i||0,startTime:Date.now()}}),this.updateUI()}startTimer(t,a){clearInterval(this.timerInterval);const i=Date.now()+(t||0);this.timerInterval=setInterval(()=>{const r=Date.now(),n=Math.max(0,i-r),o=t-n;s({timer:{...e.timer,duration:t,remainingTime:n}}),this.updateTimerDisplay(o),n<=0&&(clearInterval(this.timerInterval),this.timerInterval=null,a&&a())},100)}updateTimerDisplay(t){if(!this.timerElement)return;const a=Math.floor(t/1e3),s=Math.floor(a/60),i=a%60;if(this.timerElement.textContent=`${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`,this.progressBar&&"hold"!==e.currentPhase){const a=Math.min(100,t/e.timer.duration*100);this.progressBar.style.width=`${a}%`}}getRemainingTime(){return e.timer.startTime&&e.timer.duration?Math.max(0,e.timer.duration-(Date.now()-e.timer.startTime)):0}formatTime(t){const e=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}updateUI(){this.phaseText&&(this.phaseText.style.opacity="0",this.phaseText.style.transform="translateY(10px)",setTimeout(()=>{this.phaseText.textContent=this.getPhaseMessage(),this.phaseText.style.opacity="0.9",this.phaseText.style.transform="translateY(0)"},150)),this.circleText&&(this.circleText.style.opacity="0",this.circleText.style.transform="scale(0.8)",setTimeout(()=>{this.circleText.textContent=this.getCircleText(),this.circleText.style.opacity="1",this.circleText.style.transform="scale(1)"},100)),this.breathCounter&&(this.breathCounter.style.display="none");const t=document.getElementById("progressBar");if(t)if(e.isBreathing)if("inhale"===e.currentPhase||"exhale"===e.currentPhase){const a=Math.min(100,this.breathCount/30*100);t.style.width=`${a}%`,"inhale"===e.currentPhase?t.style.background="linear-gradient(90deg, #4a90e2, #357abd)":"exhale"===e.currentPhase&&(t.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)")}else"recoveryInhale"===e.currentPhase||"recoveryExhale"===e.currentPhase?(t.style.width="100%","recoveryInhale"===e.currentPhase?t.style.background="linear-gradient(90deg, #4a90e2, #357abd)":t.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)"):"hold"!==e.currentPhase&&"recoveryHold"!==e.currentPhase||(t.style.width="0%",t.style.background="linear-gradient(90deg, #ff6b6b, #e74c3c)");else t.style.width="0%";if(this.currentRoundElement&&this.totalRoundsElement&&(this.currentRoundElement.textContent=e.rounds.current,this.totalRoundsElement.textContent=e.rounds.total),this.breathCircle){e.isBreathing?this.breathCircle.classList.add("breathing"):this.breathCircle.classList.remove("breathing"),e.isPaused?this.breathCircle.classList.add("paused"):this.breathCircle.classList.remove("paused");["inhale","exhale","hold","recovery"].forEach(t=>{e.currentPhase===t?this.breathCircle.classList.add(t):this.breathCircle.classList.remove(t)})}}getPhaseMessage(){if(e.isPaused)return"Пауза";switch(e.currentPhase){case"inhale":return t.MESSAGES.INHALE;case"exhale":return t.MESSAGES.EXHALE;case"hold":return t.MESSAGES.HOLD;case"recoveryInhale":return"Глубокий вдох";case"recoveryHold":return"Задержка";case"recoveryExhale":return"Выдох";case"recovery":return t.MESSAGES.RECOVERY;case"finalHold":return t.MESSAGES.FINAL_HOLD;default:return t.MESSAGES.PRESS_TO_START}}getCircleText(){if(e.isPaused)return"▶";if(!e.isBreathing)return t.MESSAGES.START;switch(e.currentPhase){case"hold":case"finalHold":case"recoveryHold":return"👃";case"recoveryInhale":return"⬆️";case"recoveryExhale":return"⬇️";case"inhale":case"exhale":return this.breathCount>0?this.breathCount:e.rounds.current;case"recovery":return"♻️";default:return e.rounds.current}}setupBackgroundHandlers(){}};const o=new class{constructor(){this.player=null,this.isPlayerReady=!1,this.playlist=[],this.currentTrackIndex=0,this.initYouTubePlayer()}initYouTubePlayer(){if("undefined"==typeof YT||void 0===YT.Player){const t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";const e=document.getElementsByTagName("script")[0];return e.parentNode.insertBefore(t,e),void setTimeout(()=>this.initYouTubePlayer(),2e3)}try{this.player=new YT.Player(t.SELECTORS.YOUTUBE_PLAYER,{height:"0",width:"0",playerVars:t.YOUTUBE.PLAYER_VARS,events:{onReady:this.onPlayerReady.bind(this),onStateChange:this.onPlayerStateChange.bind(this),onError:this.onPlayerError.bind(this)}})}catch(e){}}onPlayerReady(t){this.isPlayerReady=!0;try{this.setVolume(50),this.play(),s({music:{...e.music,isPlaying:!0}})}catch(a){}}onPlayerStateChange(a){const i=document.querySelector(t.SELECTORS.MUSIC_CONTROL);i&&(a.data===YT.PlayerState.PLAYING?(i.classList.add("playing"),i.innerHTML='<span style="transform: scale(0.8);">⏸</span>',s({music:{...e.music,isPlaying:!0}})):a.data!==YT.PlayerState.PAUSED&&a.data!==YT.PlayerState.ENDED||(i.classList.remove("playing"),i.innerHTML='<span style="transform: scale(1.2);">🎵</span>',s({music:{...e.music,isPlaying:!1}}),a.data===YT.PlayerState.ENDED&&this.playNext()))}onPlayerError(t){2!==t.data&&100!==t.data&&101!==t.data&&150!==t.data||this.playNext()}async loadPlaylist(){if(this.isPlayerReady)try{const a=await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${t.YOUTUBE.PLAYLIST_ID}&key=YOUR_YOUTUBE_API_KEY`),i=await a.json();i.items&&i.items.length>0&&(this.playlist=i.items.map(t=>({id:t.snippet.resourceId.videoId,title:t.snippet.title,thumbnail:t.snippet.thumbnails.default.url})),null===e.music.currentTrack&&this.playlist.length>0&&(this.currentTrackIndex=Math.floor(Math.random()*this.playlist.length),s({music:{...e.music,currentTrack:this.playlist[this.currentTrackIndex]}})))}catch(a){}}togglePlay(){window.app&&window.app.youTubePlayer?e.music.isPlaying?(window.app.youTubePlayer.pauseVideo(),s({music:{...e.music,isPlaying:!1}})):(window.app.youTubePlayer.playVideo(),s({music:{...e.music,isPlaying:!0}})):window.app&&window.app.initializeYouTubePlayer()}play(){window.app&&window.app.youTubePlayer?e.music.currentTrack?(window.app.youTubePlayer.playVideo(),s({music:{...e.music,isPlaying:!0}})):this.playlist.length>0?(this.currentTrackIndex=Math.floor(Math.random()*this.playlist.length),s({music:{...e.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"})):this.loadPlaylist().then(()=>{this.playlist.length>0&&this.play()}):window.app&&window.app.initializeYouTubePlayer()}pause(){window.app&&window.app.youTubePlayer&&(window.app.youTubePlayer.pauseVideo(),s({music:{...e.music,isPlaying:!1}}))}playNext(){return window.app&&window.app.youTubePlayer?0===this.playlist.length?this.loadPlaylist().then(()=>{this.playlist.length>0&&this.playNext()}):(this.currentTrackIndex=(this.currentTrackIndex+1)%this.playlist.length,s({music:{...e.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"}),Promise.resolve()):Promise.reject("YouTube Player не инициализирован")}playPrevious(){return window.app&&window.app.youTubePlayer?0===this.playlist.length?this.loadPlaylist().then(()=>{this.playlist.length>0&&this.playPrevious()}):(this.currentTrackIndex=(this.currentTrackIndex-1+this.playlist.length)%this.playlist.length,s({music:{...e.music,currentTrack:this.playlist[this.currentTrackIndex],isPlaying:!0}}),window.app.youTubePlayer.loadVideoById({videoId:this.playlist[this.currentTrackIndex].id,startSeconds:0,suggestedQuality:"small"}),Promise.resolve()):Promise.reject("YouTube Player не инициализирован")}setVolume(t){if(window.app&&window.app.youTubePlayer){const a=Math.max(0,Math.min(100,t));window.app.youTubePlayer.setVolume(a),s({settings:{...e.settings,volume:a/100}})}}toggleMute(){if(window.app&&window.app.youTubePlayer){const t=!e.music.isMuted;t?window.app.youTubePlayer.mute():window.app.youTubePlayer.unMute(),s({music:{...e.music,isMuted:t}})}}getCurrentTrack(){return e.music.currentTrack}getPlaylist(){return[...this.playlist]}};new class{constructor(){this.chart=null,this.chartCtx=document.getElementById("dailyStatsChart")?.getContext("2d"),this.initChart()}initChart(){this.chartCtx&&(this.chart=new Chart(this.chartCtx,{type:"line",data:{labels:[],datasets:[{label:"Время задержки (сек)",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",borderWidth:2,tension:.4,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(t){return`Время: ${t.parsed.y} сек`}}}},scales:{y:{beginAtZero:!0,title:{display:!0,text:"Секунды"}},x:{title:{display:!0,text:"Дата"}}}}}),this.updateChart())}updateChart(){if(!this.chart)return;const t=this.getLastWeekData();this.chart.data.labels=t.labels,this.chart.data.datasets[0].data=t.data,this.chart.update()}getLastWeekData(){const t={labels:[],data:[]},a=new Date;for(let s=6;s>=0;s--){const i=new Date(a);i.setDate(i.getDate()-s);const r=i.toISOString().split("T")[0],n=this.getDayName(i.getDay()),o=e.stats.allTime.times.filter(t=>new Date(t.timestamp).toISOString().split("T")[0]===r).map(t=>t.duration),l=o.length>0?Math.max(...o):0;t.labels.push(n),t.data.push(l)}return t}getDayName(t){return["Вс","Пн","Вт","Ср","Чт","Пт","Сб"][t]}updateStatsDisplay(){document.getElementById("sessionsToday").textContent=e.stats.today.sessions,document.getElementById("bestTimeToday").textContent=this.formatTime(e.stats.today.bestTime),document.getElementById("avgTimeToday").textContent=this.calculateAverageTime(e.stats.today.times),document.getElementById("totalSessions").textContent=e.stats.allTime.sessions,document.getElementById("bestTimeAll").textContent=this.formatTime(e.stats.allTime.bestTime),document.getElementById("avgTimeAll").textContent=this.calculateAverageTime(e.stats.allTime.times),document.getElementById("streakDays").textContent=e.stats.allTime.streak,this.updateChart()}calculateAverageTime(t){if(!t||0===t.length)return this.formatTime(0);const e=t.reduce((t,e)=>t+e,0),a=Math.round(e/t.length);return this.formatTime(a)}formatTime(t){if(isNaN(t))return"00:00";const e=Math.floor(t/60),a=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}addSession(t){const a=new Date;a.toISOString().split("T")[0];const i=e.stats.allTime.lastPractice?new Date(e.stats.allTime.lastPractice):null;let r=e.stats.allTime.streak;if(i){const t=Math.floor((a-i)/864e5);1===t?r++:t>1&&(r=1)}else r=1;s({stats:{today:{...e.stats.today,sessions:e.stats.today.sessions+1,bestTime:Math.max(e.stats.today.bestTime,t),times:[...e.stats.today.times,{timestamp:a,duration:t}]},allTime:{...e.stats.allTime,sessions:e.stats.allTime.sessions+1,bestTime:Math.max(e.stats.allTime.bestTime,t),times:[...e.stats.allTime.times,{timestamp:a,duration:t}],streak:r,lastPractice:a.toISOString()}}}),this.updateStatsDisplay(),this.checkAchievements()}checkAchievements(){const t={...e.achievements};let a=!1;e.stats.allTime.sessions>=1&&!t.firstSession&&(t.firstSession=!0,a=!0,this.showAchievement("Первая сессия","Вы завершили свою первую сессию дыхания!")),e.stats.allTime.streak>=7&&!t.weekStreak&&(t.weekStreak=!0,a=!0,this.showAchievement("Неделя практики","7 дней подряд практики дыхания!")),e.stats.allTime.streak>=30&&!t.monthStreak&&(t.monthStreak=!0,a=!0,this.showAchievement("Месяц практики","30 дней подряд практики дыхания!")),e.stats.allTime.sessions>=100&&!t.master&&(t.master=!0,a=!0,this.showAchievement("Мастер дыхания","100 сессий дыхания завершено!")),a&&s({achievements:t})}showAchievement(t,e){const a=document.createElement("div");a.className="achievement-notification",a.innerHTML=`\n            <div class="achievement-icon">🏆</div>\n            <div class="achievement-content">\n                <div class="achievement-title">${t}</div>\n                <div class="achievement-message">${e}</div>\n            </div>\n        `,document.body.appendChild(a),setTimeout(()=>{a.classList.add("show")},100),setTimeout(()=>{a.classList.remove("show"),setTimeout(()=>{document.body.removeChild(a)},300)},5e3)}};class l{constructor(){this.isAdjusting=!1,this.youTubePlayer=null,this.initEventListeners(),this.initTheme(),this.initTutorial(),r(),this.updateUI()}initializeYouTubePlayer(){if(!this.youTubePlayer)try{this.youTubePlayer=new YT.Player("youtubePlayer",{height:"0",width:"0",playerVars:{...t.YOUTUBE.PLAYER_VARS,enablejsapi:1,origin:window.location.origin},events:{onReady:()=>{e.music.isPlaying&&this.youTubePlayer.playVideo()},onStateChange:a=>{const i=document.querySelector(t.SELECTORS.MUSIC_CONTROL);i&&(a.data===YT.PlayerState.PLAYING?(i.classList.add("playing"),i.innerHTML='<span style="transform: scale(0.8);">⏸</span>',s({music:{...e.music,isPlaying:!0}})):a.data!==YT.PlayerState.PAUSED&&a.data!==YT.PlayerState.ENDED||(i.classList.remove("playing"),i.innerHTML='<span style="transform: scale(1.2);">🎵</span>',s({music:{...e.music,isPlaying:!1}})))},onError:t=>{}}})}catch(a){}}initEventListeners(){document.querySelectorAll(".stats-tab").forEach(t=>{t.addEventListener("click",t=>this.handleStatsTabClick(t))});const a=document.getElementById("roundsInput");a&&a.addEventListener("change",a=>{let i=parseInt(a.target.value,10);isNaN(i)||i<t.BREATHING.MIN_ROUNDS?i=t.BREATHING.MIN_ROUNDS:i>t.BREATHING.MAX_ROUNDS&&(i=t.BREATHING.MAX_ROUNDS),s({rounds:{...e.rounds,total:i}}),a.target.value=i});const i=document.querySelector(".rounds-display");i&&(i.addEventListener("click",()=>{const i=prompt("Введите количество раундов (1-10):",e.rounds.total);if(null!==i){let r=parseInt(i,10);isNaN(r)||r<t.BREATHING.MIN_ROUNDS?r=t.BREATHING.MIN_ROUNDS:r>t.BREATHING.MAX_ROUNDS&&(r=t.BREATHING.MAX_ROUNDS),s({rounds:{...e.rounds,total:r}}),a&&(a.value=r)}}),i.style.cursor="pointer");const r=document.getElementById("musicControl");r&&r.addEventListener("click",()=>o.togglePlay());const n=document.getElementById("themeToggle");n&&n.addEventListener("click",()=>this.toggleTheme());const l=document.getElementById("closeTutorial");l&&l.addEventListener("click",()=>this.hideTutorial())}initTheme(){const t=localStorage.getItem("theme"),a=window.matchMedia("(prefers-color-scheme: dark)").matches;"dark"===t||!t&&a?(document.documentElement.setAttribute("data-theme","dark"),s({settings:{...e.settings,darkMode:!0}})):(document.documentElement.setAttribute("data-theme","light"),s({settings:{...e.settings,darkMode:!1}}))}initTutorial(){if(this.currentTutorialStep=0,this.tutorialSteps=[{title:"Добро пожаловать!",content:"Это приложение поможет вам освоить технику дыхания Вим Хофа. Давайте начнем!"},{title:"Как это работает",content:"1. Сделайте 30 глубоких вдохов и выдохов\n2. После последнего выдоха задержите дыхание\n3. После задержки сделайте глубокий вдох и задержите дыхание на 15 секунд"},{title:"Готовы начать?",content:'Нажмите "Готово" чтобы приступить к практике.'}],!e.tutorial.isCompleted){this.showTutorial(),this.updateTutorialStep(0);const t=document.getElementById("prevStep"),e=document.getElementById("nextStep");t&&e&&(t.addEventListener("click",()=>this.prevTutorialStep()),e.addEventListener("click",()=>this.nextTutorialStep()))}}showTutorial(){const t=document.getElementById("tutorial");t&&(t.style.display="flex",setTimeout(()=>{t.classList.add("show")},100))}updateTutorialStep(t){this.currentTutorialStep=t;const e=document.getElementById("tutorial"),a=document.getElementById("tutorialTitle"),s=document.getElementById("tutorialContent"),i=document.getElementById("prevStep"),r=document.getElementById("nextStep"),n=document.querySelector(".step-indicators");e&&a&&s&&i&&r&&n&&(a.textContent=this.tutorialSteps[t].title,s.innerHTML=this.tutorialSteps[t].content.replace(/\n/g,"<br>"),i.disabled=0===t,r.textContent=t===this.tutorialSteps.length-1?"Готово":"Далее",n.innerHTML="",this.tutorialSteps.forEach((e,a)=>{const s=document.createElement("div");s.className="step-indicator "+(a===t?"active":""),s.addEventListener("click",()=>this.updateTutorialStep(a)),n.appendChild(s)}))}nextTutorialStep(){this.currentTutorialStep<this.tutorialSteps.length-1?this.updateTutorialStep(this.currentTutorialStep+1):this.hideTutorial()}prevTutorialStep(){this.currentTutorialStep>0&&this.updateTutorialStep(this.currentTutorialStep-1)}hideTutorial(){const t=document.getElementById("tutorial");t&&(t.classList.remove("show"),setTimeout(()=>{t.style.display="none",s({tutorial:{...e.tutorial,isCompleted:!0}})},300))}toggleTheme(){const t="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t),s({settings:{...e.settings,darkMode:"dark"===t}})}adjustRounds(a){if(this.isAdjusting)return;this.isAdjusting=!0,setTimeout(()=>{this.isAdjusting=!1},300);const i=e.rounds.total+a;i>=t.BREATHING.MIN_ROUNDS&&i<=t.BREATHING.MAX_ROUNDS&&(s({rounds:{...e.rounds,total:i}}),this.updateUI())}handleStatsTabClick(t){const e=t.currentTarget,a=e.dataset.tab;document.querySelectorAll(".stats-tab").forEach(t=>t.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".stats-content").forEach(t=>{t.style.display="none"});const s=`stats${a.charAt(0).toUpperCase()+a.slice(1)}`,i=document.getElementById(s);i&&(i.style.display="block")}updateUI(){const t=document.getElementById("roundsInput");t&&(t.value=e.rounds.total);const a=document.getElementById("currentRound");a&&(a.textContent=e.rounds.current);const s=document.getElementById("totalRounds");s&&(s.textContent=e.rounds.total);const i=document.getElementById("themeIcon");i&&(i.textContent=e.settings.darkMode?"☀️":"🌙")}}function c(){const t=new l;window.app=t;const a=document.getElementById("loader");if(a&&(a.style.display="none"),window.Telegram&&window.Telegram.WebApp){const t=window.Telegram.WebApp;t.expand(),t.BackButton.onClick(()=>{e.isBreathing?n.pauseSession():t.close()}),t.BackButton.show()}return t}document.addEventListener("DOMContentLoaded",()=>{window.app||c()}),document.addEventListener("DOMContentLoaded",()=>{try{window.app=c(),window.appInitialized=!0,window.YTReady&&window.app.initializeYouTubePlayer()}catch(t){const e=document.querySelector(".app-container");e&&(e.innerHTML=`\n                        <div class="error-container" style="padding: 2rem; text-align: center;">\n                            <h2>Произошла ошибка</h2>\n                            <p>Не удалось загрузить приложение. Пожалуйста, попробуйте перезагрузить страницу.</p>\n                            <p>Если проблема сохраняется, свяжитесь с поддержкой.</p>\n                            <p style="color: #e74c3c; font-size: 0.9rem; margin-top: 1rem;">${t.message}</p>\n                        </div>\n                    `)}});
